import streamlit as st
import plotly.graph_objects as go
import time
import os
from datetime import datetime
import urllib.parse
import re

# ==========================================
# 1. デザイン設定 (CSS injection)
# ==========================================
def apply_custom_style(phase_data=None):
    # デフォルトカラー
    c_start = "#667eea"
    c_end = "#764ba2"
    
    # 質問画面ならフェーズごとの色を適用
    if phase_data:
        c_start = phase_data["color_start"]
        c_end = phase_data["color_end"]

    st.markdown(f"""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap');
    
    /* 基本設定 */
    .stApp {{
        background-color: #f8f9fa !important;
        background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
        background-size: 20px 20px;
    }}
    
    html, body, [class*="css"] {{
        font-family: 'Zen Maru Gothic', "Helvetica Neue", Arial, sans-serif;
        color: #333333 !important;
    }}
    
    .block-container {{
        padding-top: 2rem;
        padding-bottom: 5rem;
        max-width: 700px;
    }}

    /* アニメーション */
    @keyframes fadeIn {{
        from {{ opacity: 0; transform: translateY(10px); }}
        to {{ opacity: 1; transform: translateY(0); }}
    }}

    @keyframes pulse {{
        0% {{ transform: scale(1); box-shadow: 0 4px 15px {c_start}66; }}
        50% {{ transform: scale(1.03); box-shadow: 0 0 25px {c_start}99; }}
        100% {{ transform: scale(1); box-shadow: 0 4px 15px {c_start}66; }}
    }}

    /* トップ画面 */
    .hero-container {{
        text-align: center;
        padding: 40px 0;
        animation: fadeIn 1s ease-out;
    }}
    
    .hero-title {{
        font-size: 36px;
        font-weight: 900;
        line-height: 1.3;
        background: linear-gradient(135deg, {c_start} 0%, {c_end} 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 20px;
        display: inline-block;
        text-shadow: 0px 10px 20px rgba(0,0,0, 0.1);
    }}
    
    .hero-subtitle {{
        font-size: 16px;
        color: #666;
        margin-bottom: 40px;
        background: rgba(255,255,255,0.8);
        padding: 15px;
        border-radius: 15px;
        backdrop-filter: blur(5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }}

    /* 特徴ボックス */
    .feature-box {{
        background: rgba(255, 255, 255, 0.7);
        padding: 20px 10px;
        border-radius: 20px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        text-align: center;
        height: 100%;
        transition: transform 0.3s;
    }}
    .feature-box:hover {{
        transform: translateY(-5px);
        background: rgba(255, 255, 255, 0.95);
    }}
    .feature-icon {{
        font-size: 32px;
        margin-bottom: 10px;
        display: block;
        color: {c_end};
    }}
    .feature-title {{
        font-weight: 900;
        font-size: 14px;
        color: #444;
        margin-bottom: 5px;
        display: block;
    }}
    .feature-desc {{
        font-size: 11px;
        color: #888;
    }}

    /* 質問画面 */
    .stProgress > div > div > div > div {{
        background-image: linear-gradient(90deg, {c_start}, {c_end});
        border-radius: 10px;
        height: 10px !important;
        transition: all 0.5s ease;
    }}

    .question-card {{
        background-color: #FFFFFF;
        padding: 40px 25px;
        border-radius: 25px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.08);
        text-align: center;
        margin-bottom: 30px;
        border: 2px solid #f0f0f0;
        position: relative;
        overflow: hidden;
        animation: fadeIn 0.5s ease-out;
    }}
    .question-card::before {{
        content: "";
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 8px;
        background: linear-gradient(90deg, {c_start}, {c_end});
    }}
    
    .phase-badge {{
        display: inline-block;
        background: linear-gradient(135deg, {c_start} 0%, {c_end} 100%);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 14px;
        letter-spacing: 2px;
        margin-bottom: 15px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        text-transform: uppercase;
    }}

    .question-number {{
        color: #999;
        font-size: 12px;
        font-weight: bold;
        letter-spacing: 2px;
        margin-bottom: 10px;
        text-transform: uppercase;
        display: block;
    }}
    .question-text {{
        font-size: 22px;
        font-weight: 800;
        color: #333;
        line-height: 1.6;
    }}

    /* 結果画面 */
    .result-container {{
        background: white;
        padding: 40px 20px;
        border-radius: 30px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        margin-top: 20px;
        text-align: center;
        border: 4px solid #fff;
        position: relative;
    }}

    .result-title {{
        font-size: 28px;
        font-weight: 900;
        margin-bottom: 10px;
        letter-spacing: -1px;
        line-height: 1.4;
    }}

    .result-copy {{
        font-size: 20px;
        color: #555;
        font-weight: 700;
        margin: 25px 0;
        padding: 20px;
        background: #fff;
        border-radius: 15px;
        border-left: 6px solid {c_end};
        text-align: left;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }}
    
    .result-desc-box {{
        background-color: #ffffff !important;
        padding: 30px;
        border-radius: 20px;
        margin-bottom: 25px;
        border: 1px solid #eee;
        box-shadow: 0 5px 20px rgba(0,0,0,0.03);
    }}
    .result-desc {{
        font-size: 16px;
        color: #333333 !important;
        line-height: 1.9;
        text-align: left;
    }}
    .result-desc h4 {{
        color: {c_end};
        margin-top: 30px;
        margin-bottom: 15px;
        font-size: 18px;
        border-bottom: 2px dashed #ddd;
        padding-bottom: 5px;
        display: inline-block;
    }}

    img {{
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        margin-bottom: 20px;
    }}

    /* Expander（もっと見る） */
    .streamlit-expanderHeader, 
    div[data-testid="stExpander"] details summary {{
        background: linear-gradient(135deg, {c_start} 0%, {c_end} 100%) !important;
        color: white !important;
        font-weight: 800 !important;
        border-radius: 50px !important;
        border: none !important;
        box-shadow: 0 4px 15px rgba(0,0,0, 0.2) !important;
        transition: all 0.3s ease !important;
        padding: 1rem 1.5rem !important;
    }}
    .streamlit-expanderHeader:hover,
    div[data-testid="stExpander"] details summary:hover {{
        transform: scale(1.02);
        box-shadow: 0 8px 25px rgba(0,0,0, 0.3) !important;
        color: white !important;
        opacity: 1 !important;
    }}
    .streamlit-expanderHeader svg,
    div[data-testid="stExpander"] details summary svg {{
        fill: white !important;
        color: white !important;
        stroke: white !important;
    }}
    .streamlit-expanderContent {{
        background-color: transparent !important;
        padding: 0 !important;
        border: none !important;
    }}

    /* ボタン */
    div.stButton > button[kind="primary"], a[kind="primary"] {{
        width: 100%;
        border-radius: 50px !important;
        border: none !important;
        background: linear-gradient(135deg, {c_start} 0%, {c_end} 100%);
        color: white !important;
        font-weight: 800 !important;
        font-size: 18px !important;
        padding: 1.2rem 2rem !important;
        box-shadow: 0 10px 20px {c_start}66;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) !important;
        text-decoration: none !important;
        display: inline-block;
        text-align: center;
        animation: pulse 2s infinite ease-in-out;
    }}
    div.stButton > button[kind="primary"]:hover, a[kind="primary"]:hover {{
        animation: none;
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 15px 30px {c_start}88;
        color: white !important;
    }}
    
    div.stButton > button[kind="secondary"] {{
        width: 100%;
        border-radius: 15px !important;
        background: #FFFFFF !important;
        color: #555 !important;
        border: 2px solid #E0E0E0 !important;
        font-size: 16px !important;
        font-weight: 700 !important;
        padding: 1.2rem 1rem !important;
        margin-top: 10px;
        transition: all 0.2s ease !important;
        box-shadow: 0 4px 0 #E0E0E0 !important;
    }}
    div.stButton > button[kind="secondary"]:hover {{
        border-color: {c_end} !important;
        color: {c_end} !important;
        transform: translateY(-2px);
        box-shadow: 0 6px 0 #dcdcdc !important;
        background-color: #fbfaff !important;
    }}
    div.stButton > button[kind="secondary"]:active {{
        transform: translateY(4px);
        box-shadow: 0 0 0 #E0E0E0 !important;
    }}

    /* SNSリンクボタン */
    a[kind="secondary"] {{
        width: 100%; display: inline-block; text-align: center; text-decoration: none;
        padding: 0.8rem 1rem; border-radius: 12px; font-weight: bold; transition: all 0.2s;
        margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); color: white !important;
    }}
    a[href*="twitter.com"] {{ background: #000000; }}
    a[href*="line.me"] {{ background: #06C755; }}
    a[href*="facebook.com"] {{ background: #1877F2; }}
    a:hover {{ transform: translateY(-3px); opacity: 0.9; box-shadow: 0 8px 15px rgba(0,0,0,0.15); }}

    /* グラデーション文字 */
    .gradient-text-cool {{
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800;
    }}
    .gradient-text-warm {{
        background: linear-gradient(135deg, #ff9a44 0%, #fc6076 100%);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800;
    }}
    
    /* 黒いボックス対策：強制リセット */
    .result-desc code, .result-desc pre {{
        background-color: transparent !important;
        color: #333333 !important;
        border: none !important;
        padding: 0 !important;
        margin: 0 !important;
        white-space: normal !important;
        font-family: 'Zen Maru Gothic', sans-serif !important;
        font-size: inherit !important;
        display: inline !important;
    }}
    </style>
    """, unsafe_allow_html=True)

# ==========================================
# 2. データ定義 (超長文・完全版)
# ==========================================

TYPES = {
    "MFSP": {
        "title": "空白のショールーム", 
        "copy": "埃ひとつ、アイコンひとつ許さない", 
        "desc": """あなたの居住空間は、もはや生活の場という定義を超越し、高度に制御された<b>「思考の無菌室」</b>と化しています。視界に入るノイズ（生活感、不揃いな色彩、有機的な曲線）を極限まで排除しようとするその姿勢は、潔癖症という言葉では生ぬるく、一種の宗教的な儀式、あるいは現代アートのインスタレーションに近い狂気と美学を内包しています。<br><br><h4>🧠 深層心理と認知プロセス</h4>あなたは「内向的思考（Ti）」と「感覚的判断（Si）」を駆使し、空間におけるすべてのオブジェクトに「存在する論理的正当性」を求めます。「なんとなく置いている」という曖昧な状態は、あなたの辞書には存在しません。すべてのモノはX,Y,Z軸の座標がミリ単位で管理されており、ルンバが走行するルートさえも計算されています。この徹底した管理は、予測不可能な外界のカオスに対する、あなたの自我を守るための最も強固な防衛機制なのです。<br><br><h4>🏠 部屋の生態系と具体的特徴</h4><ul><li>机の上にはMacBookとコーヒーカップ以外、何も存在しない時間が一日の大半を占める。</li><li>配線コードは壁の裏や専用ボックスに隠蔽され、その存在を抹消されている。</li><li>本棚の本は高さ順、あるいは色別に並べられており、背表紙の凹凸さえも許さない。</li><li>床に髪の毛が一本落ちているだけで、それは「部屋」という完全な絵画に付着した異物として認識され、即座に排除される。</li></ul><br><h4>❤️ 対人関係の力学：侵入者への拒絶</h4>他者を自室に招くことは、あなたにとって聖域への侵入を許可するのと同義であり、最高レベルのセキュリティクリアランスを要します。パートナーには「精神的な自律」と「衛生観念の完全な一致」を強く求めます。あなたの整然とした空間に、脱ぎ散らかされた靴下や、原色の派手なパッケージのお菓子を持ち込むような相手とは、細胞レベルで拒絶反応を起こし、共存は不可能です。あなたは孤独を愛しているのではなく、<b>「ノイズのない完全な自由」</b>を愛しているのです。<br><br><h4>💼 才能と職業的適性</h4>プログラマー、建築家、外科医、会計士など、緻密さと論理性が求められる分野で天才的な能力を発揮します。感情や曖昧さを排した判断ができるため、危機的状況下でのトラブルシューティングにおいても冷徹なまでの実力を示します。<br><br><h4>🌑 影の側面：ストレスと崩壊</h4>精神が安定している時、あなたの生産性は神の領域に達しますが、一度ストレス過多に陥ると「完璧にできないなら全てどうでもいい」という極端な0・100思考に支配されます。その結果、突如として断捨離衝動に駆られて必要なものまで捨て去ったり、逆に糸が切れたように全く掃除ができなくなる「機能不全」に陥るリスクを孕んでいます。<br><br><h4>💡 魂への処方箋</h4><b>「管理できないカオス」を愛でる勇気を持ってください。</b>人生は不確実で、割り切れないことの連続です。部屋の隅に一つだけ、意味のないガラクタや、枯れていく花を置いてみてください。「非合理なもの」を受け入れる余白が生まれた時、あなたの冷徹な要塞は、血の通った温かい「家」へと進化し、あなたの人生はより豊かで彩りあるものになるでしょう。""", 
        "color": "#2c3e50"
    },
    "MFSL": {
        "title": "合理的なノマド", 
        "copy": "生活に必要なのは、スマホとベッドだけ", 
        "desc": """あなたの部屋は「仮宿」であり、いつでも次へ移動できる「中継地点」に過ぎません。モノを持たないのは美的ミニマリズムからではなく、<b>「所有コストと管理の手間を極限まで削減する」</b>という、冷徹なまでの合理的判断によるものです。段ボール箱をテーブル代わりにしても平気でいられるその驚異的な適応力は、高いサバイバル能力を示していますが、同時に「ここではないどこか」を常に探し求めている、根無し草のような不安定さも漂わせています。<br><br><h4>🧠 深層心理と認知プロセス</h4>「外向的直感（Ne）」が強く働き、物理的な所有物よりも、経験、情報、移動の自由、あるいはデジタル資産に重きを置きます。掃除、洗濯、片付けといった「現状維持のための管理業務」を人生の無駄な時間と捉えているため、部屋はモノが少なく散らかりにくいものの、殺風景で、どこか刑務所の独房やビジネスホテルのような無機質な冷たさがあります。過去への執着が薄く、思い出の品さえも「データ化して捨てればいい」と考えるドライさがあります。<br><br><h4>🏠 部屋の生態系と具体的特徴</h4><ul><li>家具は「捨てやすさ」や「運びやすさ」で選ばれており、折りたたみ式や軽量素材が多い。</li><li>冷蔵庫の中身は空に近いか、飲料水と保存食のみ。料理器具は最低限。</li><li>カーテンすら無くても気にしない、あるいは雨戸で済ませる合理性。</li><li>寝具にはこだわるが、ベッドフレームは邪魔だと感じる（マットレス直置き派）。</li></ul><br><h4>❤️ 対人関係の力学：束縛との戦い</h4>人間関係においても「来るもの拒まず去るもの追わず」のスタンスを貫きます。束縛や依存を何より嫌い、互いの自由を尊重できるドライな関係を好みます。しかし、その態度はパートナーから見ると「情熱がない」「何を考えているかわからない」「私がいなくても生きていけそう」と不安がられる原因となり、情緒的な深い繋がりを構築する際に壁となるでしょう。記念日などの形式的なイベントにも興味がありません。<br><br><h4>💼 才能と職業的適性</h4>コンサルタント、フリーランス、起業家、ジャーナリストなど、特定の場所や組織に縛られずに結果を出せる仕事が天職です。変化を恐れず、むしろ変化をエネルギーに変える力があります。<br><br><h4>🌑 影の側面：ストレスと崩壊</h4>身軽さは最強の武器ですが、精神的に疲弊すると「現実逃避」の傾向が強まります。部屋に寝袋一つで引きこもり、ネットやゲームのデジタル世界に没入して現実の肉体や生活を疎かにしがちです。根を張っていないため、嵐が来た時に吹き飛ばされやすい脆さもあります。<br><br><h4>💡 魂への処方箋</h4><b>「定住」することの豊かさを知ってください。</b>効率を追求するあまり、生活の「手触り」や「匂い」、「季節感」を失っていませんか？ 面倒くさい観葉植物を育てたり、重たくて持ち運べない重厚な家具を一つ買ってみることは、あなたの人生に「根」を張り、情緒という彩りを与える重要なステップとなるはずです。""", 
        "color": "#7f8c8d"
    },
    "MESP": {
        "title": "孤高の美術館", 
        "copy": "余白を愛するアーティスト", 
        "desc": """あなたの部屋は、選び抜かれた作品だけを展示するプライベート・ギャラリーです。そこにあるのは生活必需品ではなく、あなたの厳しい美意識というフィルターを通過し、存在することを許された<b>「承認されたオブジェクト」</b>のみ。座り心地の悪いデザイナーズチェアや、一日の光の移ろいまで計算されたオブジェの配置は、あなたの自己表現そのものであり、俗世間の妥協やノイズに対する、静かなる抵抗運動です。<br><br><h4>🧠 深層心理と認知プロセス</h4>卓越した「内向的感覚（Fi）」と鋭敏な審美眼を持っています。あなたは実用性やコストパフォーマンスよりも、「美しさ」「ストーリー」「佇まい」に絶対的な価値を置きます。コンビニのレジ袋、派手な色の洗剤パッケージ、プラスチックの収納ケースといった「美しくないノイズ」が視界に入ると、物理的な苦痛や不快感を感じるほど、繊細で過敏な感性の持ち主です。<br><br><h4>🏠 部屋の生態系と具体的特徴</h4><ul><li>照明は決してシーリングライトを使わず、間接照明だけで陰影を作る。</li><li>生活感が出るものは徹底的に隠蔽され、ティッシュ箱さえも排除されている。</li><li>一見何もない空間に見えるが、壁の余白のバランスに数ミリ単位のこだわりがある。</li><li>高価なブランド家具と、道端で拾った石ころが同列に扱われている。</li></ul><br><h4>❤️ 対人関係の力学：感性の共鳴</h4>他者に対しても高い美意識とデリカシーを求めます。ファッションセンスが悪い人、言葉選びが粗雑な人、声が大きい人とは、生理的に距離を置こうとします。心を開くのには非常に時間がかかりますが、一度感性が共鳴した相手とは、言葉を介さずとも通じ合えるソウルメイトのような深く濃密な関係を築きます。ただし、相手の美意識が少しでもズレると一気に冷める冷酷さも持ち合わせています。<br><br><h4>💼 才能と職業的適性</h4>デザイナー、アーティスト、編集者、建築家など、独自の美意識を形にする仕事で成功します。妥協を許さない姿勢は、クオリティの高い成果物を生み出します。<br><br><h4>🌑 影の側面：ストレスと崩壊</h4>その空間はあなたのクリエイティビティを高めますが、理想と現実のギャップに極めて弱いです。少しでも部屋のバランスが崩れると（例えば配線の乱れや、意図しない色味の混入）、強いストレスを感じてヒステリックになる傾向があります。自己愛と自己否定の間で常に揺れ動く、孤独な芸術家です。<br><br><h4>💡 魂への処方箋</h4><b>「不完全の美（わび・さび）」を受け入れてください。</b>完璧に計算された空間は美しいですが、同時に他者を拒絶する冷たさも持っています。少し崩れたもの、歪なもの、あるいは他人が持ち込んだ異質なものを受け入れることで、あなたの美意識は「排他的な美」から、より懐の深い「包摂的な美」へと昇華されるでしょう。""", 
        "color": "#34495e"
    },
    "MESL": {
        "title": "未完のアトリエ", 
        "copy": "美意識はあるが、布団からは出られない", 
        "desc": """あなたの部屋は、永遠に完成することのない前衛芸術の実験場であり、制作途中のバックヤードです。コンクリート打ちっ放しの壁や無機質な家具への憧れは見え隠れしますが、床には読みかけのアートブック、脱ぎ捨てられたこだわりの服、飲みかけのコーヒーカップが散乱しています。しかし、その散らかり方すらも、計算されたかのような「ラフさ」や「生活のアート」として肯定してしまう、独特のルーズさと愛嬌を持った空間です。<br><br><h4>🧠 深層心理と認知プロセス</h4>典型的な直感型で気分屋。右脳的なインスピレーションで動くため、ルーティンワークや規則正しい生活が大の苦手です。「片付けなきゃ」という意識は頭の片隅にありますが、「今、この瞬間のひらめき」や「眠気」を優先してしまうため、常に部屋はエントロピーが増大する方向に進みます。しかし、モノ自体は厳選されており少ないため、本気を出せば30分で完璧に片付くポテンシャルも秘めています。<br><br><h4>🏠 部屋の生態系と具体的特徴</h4><ul><li>服は畳まずにハンガーにかけるか、椅子の背もたれに積み上がって「地層」ができている。</li><li>観葉植物を置きたがるが、水やりを忘れて枯らしてしまう常習犯。</li><li>間接照明やアロマなど、雰囲気作りのアイテムだけは一丁前に揃っている。</li><li>「やる気が出たらやる」と言って、そのやる気が半年間来ていない場所がある。</li></ul><br><h4>❤️ 対人関係の力学：夢見るロマンチスト</h4>恋愛体質で惚れっぽい性格です。ドラマチックな展開や運命的な出会いを好みますが、継続力や忍耐力に欠けるため、関係がマンネリ化するとすぐに飽きてしまうことも。あなたの散らかった部屋を「だらしないなぁ」と笑って許し、また一緒に片付けてくれるような、現実的で包容力のあるパートナー（あるいは世話焼きオカン的な人）が必要です。<br><br><h4>💼 才能と職業的適性</h4>企画職、ライター、ファッション関係、美容師など、自由な発想と個性が許される環境で輝きます。締め切り直前まで動かないスロースターターですが、爆発力は凄まじいです。<br><br><h4>🌑 影の側面：ストレスと崩壊</h4>自由な反面、生活リズムが乱れやすく、昼夜逆転や食生活の乱れが部屋の荒廃に直結します。メンタルが落ち込むと、おしゃれだった部屋は一瞬で「ただの不衛生なゴミ屋敷」へと変貌し、そこから抜け出せなくなる負のループに陥ります。<br><br><h4>💡 魂への処方箋</h4><b>「小さな完了」を積み重ねてください。</b>壮大な理想の部屋を思い描いて挫折するよりも、「靴下をカゴに入れる」「マグカップを一つ洗う」といった、3分で終わる小さなタスクを完了させる癖をつけることです。未完の天才も魅力的ですが、物事を完成させる喜びを知ることで、あなたの才能は社会的な信用を得て、より大きく開花します。""", 
        "color": "#95a5a6"
    },
    "MWSP": {
        "title": "現代の茶室", 
        "copy": "整えられた呼吸、整えられた空間", 
        "desc": """あなたの部屋には、張り詰めた静寂の中に木の温もりが漂う、禅（Zen）の精神が宿っています。モノは極限まで削ぎ落とされていますが、そこには冷徹さはなく、活けられた一輪の花や、使い込まれた茶器、丁寧に畳まれたリネン類のように、静かな命の通った気配があります。空間を整えることが、そのまま精神を整える修行となっており、俗世の穢れを落とすための聖域として機能しています。<br><br><h4>🧠 深層心理と認知プロセス</h4>「内向的直観（Ni）」と「外向的感情（Fe）」のバランスが取れています。物質的な多さよりも精神的な深さや充足を重視し、「丁寧な暮らし」を実践することで自己肯定感を保っています。毎朝の換気、床の水拭き、靴を揃えるといった儀式的なルーティンが、あなたの精神的安定を支える重要な柱となっています。<br><br><h4>🏠 部屋の生態系と具体的特徴</h4><ul><li>家具は木製や自然素材が中心で、プラスチック製品を極端に嫌う。</li><li>香りに敏感で、お香や天然のアロマが常に焚かれている。</li><li>テレビがない、あるいは隠されている（静寂を乱すため）。</li><li>来客用の食器や座布団は常に完璧に用意されている。</li></ul><br><h4>❤️ 対人関係の力学：静かなる拒絶</h4>誠実で穏やかな関係を築き、聞き上手として周囲から信頼されます。しかし、あなたの聖域（精神的・物理的領域）を土足で踏み荒らす無神経な人間や、騒がしい人間には、静かに、しかし徹底的に心のシャッターを下ろします。言葉よりも「察すること」を相手に求める傾向があり、言わぬが花のハイコンテクストなコミュニケーションを好みます。<br><br><h4>💼 才能と職業的適性</h4>カウンセラー、教師、伝統工芸の職人、鍼灸師など、人と深く向き合ったり、一つの道を極める仕事に向いています。<br><br><h4>🌑 影の側面：ストレスと崩壊</h4>「正しさ」や「清らかさ」に囚われるあまり、自分にも他人にも厳しくなりすぎるきらいがあります。ジャンクフードを食べたり、だらしなく過ごすことを自分に許せず、無意識のうちに息苦しさを抱えているかもしれません。潔癖さが行き過ぎると、他者を排除する排他性に繋がります。<br><br><h4>💡 魂への処方箋</h4><b>「俗」を楽しむゆとりを持ってください。</b>高尚な精神性は素晴らしいですが、時には泥臭く、欲望に忠実になることも人間らしさの重要な一部です。カップラーメンを啜りながら深夜番組を見て大笑いするような、俗っぽい時間を自分に許した時、あなたの精神性はより深みと弾力を持つものになるはずです。""", 
        "color": "#d35400"
    },
    "MWSL": {
        "title": "陽だまりのナマケモノ", 
        "copy": "床でゴロゴロするのが最高", 
        "desc": """ここは世界で一番、重力が強く作用する場所です。背の高い家具を置かず、ラグやクッション、Yogiboなどを多用したロースタイルの部屋は、一度座り込むと二度と立ち上がれない「人をダメにする空間」の極み。散らかってはいますが、不潔ではなく、むしろその乱雑さが「生活の温もり」や「隙」として肯定的に機能している、究極の癒やしスポットです。<br><br><h4>🧠 深層心理と認知プロセス</h4>すべての判断基準は「心地よいかどうか」です。効率や見た目の美しさよりも、肌触り、座り心地、日当たりの良さを最優先します。楽観的でマイペース、競争社会のレールから降りて、日々の小さな幸せ（日向ぼっこ、美味しいコーヒー、昼寝）を噛み締めて生きる達人です。片付けは「来客がある直前」にしか発動しません。<br><br><h4>🏠 部屋の生態系と具体的特徴</h4><ul><li>ソファがあるのに床に座り、ソファを背もたれにしている。</li><li>手の届く範囲にリモコン、ティッシュ、お菓子、充電器が全て集結している。</li><li>カーテンは遮光性よりも、光が綺麗に入る透け感重視。</li><li>冬はコタツが登場し、春までそこから動かなくなる。</li></ul><br><h4>❤️ 対人関係の力学：平和主義と受動性</h4>癒やし系として愛され、あなたの周りには自然と人が集まりリラックスします。しかし、極めて受動的で、自分から関係をリードしたり問題を解決したりするのは苦手です。「なんとかなるさ」が口癖で、決断を先送りにし、パートナーに依存しがちな一面も。一緒にダラダラできる相手とは最高の相性ですが、向上心の強い相手やせっかちな相手とはペースが合わず苦労します。<br><br><h4>💼 才能と職業的適性</h4>福祉関係、セラピスト、図書館司書、あるいはのんびりとしたカフェの店員など、競争やノルマのない穏やかな環境で輝きます。<br><br><h4>🌑 影の側面：ストレスと崩壊</h4>現状維持バイアスが強く、新しい挑戦や面倒な決断を極端に避ける傾向があります。部屋の空気が淀むように、人生も停滞してしまうリスクがあります。トラブルが起きても「見なかったこと」にして現実逃避し、事態を悪化させてしまうことも。<br><br><h4>💡 魂への処方箋</h4><b>「窓を開けて風を通す」こと。</b>物理的にも、心理的にもです。居心地の良い殻に閉じこもるのは幸せですが、外の世界からの刺激や変化を意識的に取り入れないと、あなたの感性は徐々に鈍化してしまいます。一日一回、あえて居心地の悪い場所に行ってみるのも、あなたにとっては必要な修行になるでしょう。""", 
        "color": "#f39c12"
    },
    "MWFP": {
        "title": "無印良品のカタログ", 
        "copy": "収納ケースのサイズが揃わないと発狂する", 
        "desc": """あなたの部屋は、機能美とナチュラルさが融合した<b>「標準化されたユートピア」</b>です。無印良品や北欧家具で統一された空間は、個性を主張しすぎず、しかし誰もが「良い部屋だね」と認める普遍的な正解を体現しています。すべての引き出しの中には仕切りがあり、すべてのモノには住所（定位置）が割り振られており、ラベリングによって管理されています。<br><br><h4>🧠 深層心理と認知プロセス</h4>「外向的思考（Te）」により、生活のシステム化と最適化を好みます。温かみのある素材を選びつつも、その配置や管理方法は極めてロジカルかつ事務的。生活のノイズをコントロール下に置き、予測可能な状態に保つことで安心感を得ています。「普通であること」の最高品質を目指す、真面目な優等生タイプです。<br><br><h4>🏠 部屋の生態系と具体的特徴</h4><ul><li>収納グッズは必ず同じブランド・同じサイズで統一されている。</li><li>ゴミ箱の中身が見えないよう工夫されており、生活臭がしない。</li><li>ストック品の残量が常に把握されており、在庫切れを起こさない。</li><li>突飛な色や柄のアイテムは一切なく、ベージュ・白・木目で統一されている。</li></ul><br><h4>❤️ 対人関係の力学：正しさの押し付け</h4>安定感があり、信頼される人物です。パートナーにも「ちゃんとしていること」を求めます。約束の時間、家事の分担、金銭管理など、ルールの遵守を愛情の証と捉える傾向があります。そのため、ルーズな相手や感情的な相手に対しては教育的指導を行ってしまい、「口うるさい」「息が詰まる」と敬遠され、関係がギスギスすることもしばしば。<br><br><h4>💼 才能と職業的適性</h4>事務、経理、公務員、プロジェクトマネージャー、薬剤師など、正確性と管理能力が活きる仕事が天職です。<br><br><h4>🌑 影の側面：ストレスと崩壊</h4>「マニュアル通り」にいかない事態に弱く、想定外のトラブルや、コントロール不可能な他人の感情に直面すると、パニックに陥りやすい脆さがあります。部屋が乱れることは、あなたにとって自己管理能力の喪失と人間としての敗北を意味するため、散らかった状態では精神が持ちません。<br><br><h4>💡 魂への処方箋</h4><b>「脱・正解思考」です。</b>カタログ通りの部屋は美しいですが、そこにはあなたの「偏愛」や「狂気」、つまり人間味のある魅力が欠けているかもしれません。誰にも理解されないような変な置物や、機能性のない無駄なものを一つ置いてみましょう。その「ノイズ」こそが、あなたという人間をユニークにするスパイスとなるのです。""", 
        "color": "#e67e22"
    },
    "MWFL": {
        "title": "サステナブルな実家感", 
        "copy": "古き良き温もりと、少しの生活感", 
        "desc": """あなたの部屋に入った瞬間、誰もが「懐かしい」「落ち着く」と感じてしまう、強力な引力を持った空間です。最新の流行家具よりも、長く使い込まれた道具や、誰かから譲り受けたモノたちが、少し雑多に、しかし平和に共存しています。洗練されてはいませんが、そこには見栄や虚飾のない、等身大の人間の生活が確かに息づいています。<br><br><h4>🧠 深層心理と認知プロセス</h4>変化を嫌い、安定と継続を好む保守的な性質を持っています。新しいモノを次々と買い換える消費社会には懐疑的で、「もったいない精神」が根底にあり、一つのモノを修理しながら長く使うことに喜びを感じます。少し散らかっていても、「どこに何があるか」は身体感覚として全て把握しています。<br><br><h4>🏠 部屋の生態系と具体的特徴</h4><ul><li>実家から持ってきた謎のタオルや食器が現役で活躍している。</li><li>コタツの上には常にミカンやお菓子が置かれ、おもてなしの準備ができている。</li><li>段ボールや空き缶を「何かに使えるかも」と取っておく。</li><li>最新の家電よりも、使い慣れた古い型番のものを愛用する。</li></ul><br><h4>❤️ 対人関係の力学：深くて長い絆</h4>家族や古い友人、地域の繋がりを何より大切にします。恋愛でも、ドキドキするような駆け引きや刺激より、一緒にテレビを見て笑い合えるような家族的な安心感を求めます。派手さはありませんが、一度信頼関係を築けば決して裏切らない、情に厚く献身的なパートナーとなります。ただし、身内には甘く、部外者には排他的になる一面も。<br><br><h4>💼 才能と職業的適性</h4>教育、保育、人事、接客業、農業など、人と深く関わりサポートする仕事や、地域や組織に根ざしてコツコツ働く仕事に向いています。<br><br><h4>🌑 影の側面：ストレスと崩壊</h4>地に足の着いた生活力がありますが、過去への執着が強く、思い出の品を捨てられずに溜め込んでしまう傾向があります。部屋がモノで溢れ始めると、思考も過去に縛られ、未来への一歩が踏み出せなくなります。「捨てられない」ということは、新しい運気が入ってくるスペースがないということです。<br><br><h4>💡 魂への処方箋</h4><b>「更新（アップデート）」を恐れないでください。</b>古いものを大切にするのは美徳ですが、それは時に、新しい自分への変化を拒む言い訳になります。1年に1つでいいので、部屋の何かを新しく変えてみてください。部屋の代謝を良くすることは、あなたの人生の新陳代謝を促すことにつながります。""", 
        "color": "#795548"
    },
    "CFSP": {
        "title": "司令官のコックピット", 
        "copy": "全ての操作を、椅子から動かずに", 
        "desc": """ここは部屋ではなく、世界を制御するための<b>「戦略指令室（コックピット）」</b>です。マルチモニター、エルゴノミクスチェア、整然と並ぶハイエンドなガジェット類。あなたのデスク周りは、一歩も動かずに世界中の情報にアクセスし、あらゆる作業を完結させるために構築された、機能拡張された身体の一部です。配線の美しさに美的興奮を覚える、サイバーパンクな合理主義者です。<br><br><h4>🧠 深層心理と認知プロセス</h4>圧倒的な「内向的思考（Ti）」による最適化の鬼です。モノは多いですが、その全てに明確な役割とスペック上の根拠があります。LEDライトの色味一つ、キーボードの打鍵感一つにも意味があり、空間全体があなたの脳内回路の物理的な投影となっています。非合理的な装飾や、スペックの低い家電は、あなたの宇宙には存在を許されません。<br><br><h4>🏠 部屋の生態系と具体的特徴</h4><ul><li>デスクの下の配線処理が芸術的なまでに整理されている。</li><li>スマートホーム化が進んでおり、声一つで照明や家電を操作できる。</li><li>黒、シルバー、ネオンカラーで統一された近未来的な色彩設計。</li><li>アナログな紙の本や書類は極力排除され、すべてデジタル化されている。</li></ul><br><h4>❤️ 対人関係の力学：論理的互恵関係</h4>感情論で語りかけてくる相手や、非効率なやり取りを強いる相手を苦手にします。議論や共通の趣味（ゲームやテクノロジー）を通じて繋がることを好み、対等な知的交流を求めます。「察してほしい」「共感してほしい」という要求は、あなたにとって解読不能なエラーコードでしかなく、フリーズの原因となります。恋愛もスペックや相性を分析しがちです。<br><br><h4>💼 才能と職業的適性</h4>エンジニア、データサイエンティスト、金融トレーダー、研究者など、高い分析力と論理的思考が活きる仕事で活躍します。<br><br><h4>🌑 影の側面：ストレスと崩壊</h4>高い処理能力を持ちますが、デジタルデータや理論に偏重しすぎ、生身の身体感覚や、季節の移ろいといったアナログな情報に対して鈍感になりがちです。電脳世界に没入しすぎて、現実世界の生活（食事、睡眠、対人コミュニケーション）がおろそかになると、自律神経を崩し、心身のバランスを失います。<br><br><h4>💡 魂への処方箋</h4><b>「アナログなノイズ」を取り入れてください。</b>デジタルで制御できないもの、例えば植物を育てたり、火の揺らぎ（キャンドル）を見つめる時間を作ることです。0と1の間にある無限のグラデーションを感じることで、あなたの冷徹な論理的思考は、より人間味と深みのある「知恵」へと進化します。""", 
        "color": "#2980b9"
    },
    "CFSL": {
        "title": "マッドサイエンティストのラボ", 
        "copy": "配線の森に迷い込む", 
        "desc": """足の踏み場はありませんが、そこには本人にしか理解できない<b>「高度な秩序」</b>が存在します。積み上げられた専門書、分解された機械パーツ、絡まり合うケーブルの山は、あなたの知的好奇心が爆発した痕跡であり、常に進化の過程にある混沌（カオス）です。他人にはただのゴミに見える部品も、あなたにとっては「いつか世紀の発明に使うかもしれない重要パーツ」なのです。<br><br><h4>🧠 深層心理と認知プロセス</h4>「一点集中」の天才肌。興味のあることには寝食を忘れて没頭しますが、興味のないこと（掃除、洗濯、事務手続き、社交）へのエネルギー供給は完全にカットされます。機能性を追求してモノを増やし続けた結果、物理的スペースが飽和していますが、本人は「すぐ手が届くからこれが一番効率的だ」と主張し、片付けようとしません。<br><br><h4>🏠 部屋の生態系と具体的特徴</h4><ul><li>床には未開封のAmazonの段ボールと、空のペットボトルが転がっている。</li><li>PCモニターの周りに付箋やメモがびっしりと貼られている。</li><li>必要なものは半径1メートル以内に全て積み上げられ、要塞化している。</li><li>深夜になると覚醒し、部屋の明かりがついたまま朝を迎えることが多い。</li></ul><br><h4>❤️ 対人関係の力学：理解者求む</h4>あなたの独特な世界観を理解し、面白がってくれる相手でないと関係は続きません。「変人」と言われることを最大の褒め言葉と捉えるあなたは、同じように何かに熱狂的に没頭しているオタク気質な相手と相性が良いです。常識的な「普通の幸せ」や「丁寧な暮らし」を押し付けてくる相手とは、水と油の関係になり、激しく衝突するか、あなたが逃げ出します。<br><br><h4>💼 才能と職業的適性</h4>研究職、発明家、プログラマー、クリエイターなど、専門性を極める仕事が向いています。組織のルールに縛られない環境でこそ真価を発揮します。<br><br><h4>🌑 影の側面：ストレスと崩壊</h4>常識に囚われないイノベーターの資質がありますが、生活環境の悪化が健康に直結しやすいタイプでもあります。換気不足やハウスダストによるアレルギー、積み上げたモノの崩落など、物理的なリスクと隣り合わせの生活です。生活能力の欠如が、社会生活の破綻を招くリスクもあります。<br><br><h4>💡 魂への処方箋</h4><b>「床面積」の確保です。</b>思考の広がりは、確保された床面積に比例します。すべてのモノを捨てる必要はありませんが、せめて「ルンバが生存できるルート」だけは確保してください。物理的な空白を作ることで、脳内のメモリが解放され、さらに新しい革新的なアイデアが降りてくるようになります。""", 
        "color": "#3498db"
    },
    "CESP": {
        "title": "ストリート・セレクトショップ", 
        "copy": "スニーカーは履くものではなく飾るもの", 
        "desc": """あなたの部屋は、あなたという人間をブランド化し、プレゼンテーションするための<b>「ショールーム」</b>です。レアなスニーカー、限定フィギュア、アートレコード、ブランドの空き箱。それらは単なる所有物ではなく、あなたのアイデンティティを形成する聖遺物として、ガラスケースや棚に美しく陳列されています。「見られること」を前提としたその空間は、ナルシシズムと美学が結晶化した神殿です。<br><br><h4>🧠 深層心理と認知プロセス</h4>「外向的感覚（Se）」が鋭く、トレンド、色彩、質感に敏感です。収集癖がありますが、ただ集めるのではなく、それをいかにカッコよく「ディスプレイ」するかに命をかけています。SNS映えは必須要件。常に他者の視線や評価を意識しており、部屋の状態はあなたの社会的ステータスやセンスを証明するツールそのものです。<br><br><h4>🏠 部屋の生態系と具体的特徴</h4><ul><li>壁一面に靴や帽子がショップのようにディスプレイされている。</li><li>間接照明やネオン管を使い、夜になると部屋がクラブのような雰囲気になる。</li><li>掃除は行き届いているが、それは清潔さのためではなく「映え」のため。</li><li>鏡が大きく、自分の全身をチェックできるスペースが確保されている。</li></ul><br><h4>❤️ 対人関係の力学：共犯関係</h4>華やかで社交的。恋人にも「連れて歩いて自慢できること」や「センスの良さ」を求めがちです。お互いのファッションや趣味を高め合える刺激的な関係を望みますが、内面の弱さやダサい部分を見せ合うことには抵抗があり、関係が表面的になりやすい側面も。あなたの美学を否定するような野暮な相手とは一秒も一緒にいられません。<br><br><h4>💼 才能と職業的適性</h4>ファッション業界、広報、インフルエンサー、営業職、イベントプロデューサーなど、人を惹きつけ、流行を作り出す仕事で成功します。<br><br><h4>🌑 影の側面：ストレスと崩壊</h4>自己プロデュース能力に長けますが、承認欲求が満たされないと強い欠乏感を感じ、「もっと良いモノ」「もっとレアなモノ」を求めて散財を繰り返す買い物依存のリスクがあります。見栄のために、本当は好きでもない高価なモノに囲まれて、借金や孤独に苦しむことになるかもしれません。<br><br><h4>💡 魂への処方箋</h4><b>「誰のためでもない、自分のためのモノ」を見つけてください。</b>SNSにアップしても「いいね」がつかないかもしれない、流行りでもない、でも自分だけが猛烈に心惹かれるモノ。他人の評価軸から解放された「純粋な好き」を見つけた時、あなたは紛い物ではない、本物のカリスマ性とオリジナリティを手に入れます。""", 
        "color": "#8e44ad"
    },
    "CESL": {
        "title": "ネオン・ドンキホーテ", 
        "copy": "カワイイとカオスは紙一重", 
        "desc": """極彩色のポスター、天井から吊るされたぬいぐるみ、点滅するネオンサイン、大量のガチャガチャの景品。あなたの部屋は<b>「視覚的情報の暴力」</b>であり、同時に最強のエネルギーチャージ基地です。ヴィレッジヴァンガードやドン・キホーテの圧縮陳列のように、あなたの「好き」が過積載された空間は、退屈で灰色の現実世界からあなたを守る、結界として機能しています。<br><br><h4>🧠 深層心理と認知プロセス</h4>ドーパミン中毒気味の行動派。「欲しい！」「カワイイ！」と思った瞬間に購入ボタンを押しており、後先や置き場所は考えません。片付ける端から新しいモノが増えていくため、部屋は常に飽和状態。しかし、そのカオスの中に埋もれている時こそ、あなたは最もリラックスし、生命力を回復させているのです。空白恐怖症の傾向があります。<br><br><h4>🏠 部屋の生態系と具体的特徴</h4><ul><li>壁が見えないほどポスターやステッカーが貼られている。</li><li>ベッドの上はぬいぐるみに占拠され、自分が寝るスペースが狭い。</li><li>部屋のBGMは常に流れており、無音の状態がない。</li><li>友達が来ると「なにこれヤバい！」と盛り上がるネタアイテムが豊富。</li></ul><br><h4>❤️ 対人関係の力学：巻き込み型台風</h4>情熱的で押しが強く、好きになったら一直線です。パートナーを自分の趣味の世界に強引に引きずり込み、一緒に盛り上がることを望みます。お祭り騒ぎのような楽しい関係を築けますが、金遣いの荒さや計画性のなさ、感情の起伏の激しさで相手を疲れさせてしまうことも。「楽しいこと」を共有できない相手とは続きません。<br><br><h4>💼 才能と職業的適性</h4>イベント企画、エンタメ業界、販売員、YouTuberなど、変化と刺激にあふれ、人々を楽しませる仕事が向いています。<br><br><h4>🌑 影の側面：ストレスと崩壊</h4>常に刺激を求め、人生を全力で楽しむポジティブなオーラがあります。しかし、常に何かに興奮していないと不安になるため、部屋の情報量が多すぎて脳が休まらず、慢性的な睡眠不足や自律神経の乱れを引き起こしている可能性があります。孤独に対する耐性が低く、一人になると急に鬱状態になることも。<br><br><h4>💡 魂への処方箋</h4><b>「空白の時間」を作ることです。</b>部屋を片付けろとは言いません（それはあなたの個性を殺すことです）。ただ、一日のうち15分だけ、スマホも音楽も照明も消して、暗闇の中で深呼吸する時間を持ってください。過剰なインプットを遮断することで、あなたの内側から湧き出る本当の声が聞こえるようになります。""", 
        "color": "#9b59b6"
    },
    "CWSP": {
        "title": "英国紳士の書斎", 
        "copy": "知と歴史を整然と並べる", 
        "desc": """壁一面の本棚、重厚な革張りのソファ、アンティークの照明、そして珈琲の香り。あなたの部屋は、知と歴史を蓄積する<b>「個人的な図書館」</b>であり、時間の流れが外の世界とは異なる速度で流れています。モノは多いですが、それらは全て分類・整理され、知的探究心という文脈によって統率されています。軽薄な流行や安っぽい大量生産品を拒絶する、威厳と知性ある空間です。<br><br><h4>🧠 深層心理と認知プロセス</h4>「内向的直観（Ni）」と知識欲の塊です。モノを集めるのは、そのモノ自体が欲しいからではなく、その背景にある歴史、物語、あるいは知識を所有したいからです。プラスチック製品を嫌い、職人の手仕事や、使い込むほどに味が出る経年変化に価値を見出します。自分のルールや美学に固執する、少々頑固で保守的な一面も。<br><br><h4>🏠 部屋の生態系と具体的特徴</h4><ul><li>本はジャンルごと、作家ごとに厳密に分類されている。</li><li>家具はダークブラウンや深い色合いで統一され、重厚感がある。</li><li>万年筆、レコード、フィルムカメラなど、アナログな趣味の道具が多い。</li><li>静寂を愛し、部屋の防音や遮光にはこだわっている。</li></ul><br><h4>❤️ 対人関係の力学：知的同盟</h4>知的で落ち着いた会話を好みます。チャラチャラしたノリや、中身のない世間話は大の苦手。尊敬できる相手と、時間をかけて信頼関係を醸成していく大人の付き合いをします。パートナーには、あなたのコレクションや長時間のウンチクを静かに聞いてくれる忍耐強さと、知的な理解力が求められます。軽い付き合いは時間の無駄だと考えています。<br><br><h4>💼 才能と職業的適性</h4>研究者、大学教授、作家、弁護士、評論家など、知識と論理を武器にし、一つのことを深く掘り下げる仕事が適任です。<br><br><h4>🌑 影の側面：ストレスと崩壊</h4>博識で落ち着きがあり、周囲から一目置かれる存在です。しかし、自分の価値観が絶対だと思い込みやすく、他人の新しい価値観や軽やかなライフスタイルを見下してしまう「老害化」のリスクを秘めています。知識や理屈で武装しすぎて、素直な感情表現ができなくなり、孤立してしまうことも。<br><br><h4>💡 魂への処方箋</h4><b>「街に出る」ことです。</b>書を捨てよ、町へ出よう。あなたの部屋は心地よいですが、それは閉じた世界です。理屈では説明できないナンセンスな出来事や、理解不能な若者の文化に触れ、眉をひそめながらも面白がってみてください。知識が、生身の「体験」に変わった時、あなたの重厚な世界に軽やかな風が吹き込み、より魅力的な人物になれるでしょう。""", 
        "color": "#5d4037"
    },
    "CWSL": {
        "title": "ジブリの魔女の隠れ家", 
        "copy": "植物と古道具に埋もれて暮らす", 
        "desc": """天井から吊るされたドライフラワー、拾ってきた流木、用途不明の美しい色の瓶、古道具。あなたの部屋は、物語の中に迷い込んだような<b>「魔法使いの隠れ家」</b>です。整理整頓とは無縁ですが、植物とガラクタが有機的に絡み合い、独自の生態系を形成しています。プラスチックの冷たさを嫌い、朽ちていくもの、枯れていくものに美を見出す、シャーマンのような感性の持ち主です。<br><br><h4>🧠 深層心理と認知プロセス</h4>直感とフィーリング（INFP的気質）で生きています。「ときめき」や「波長」に従ってモノを集めますが、捨てることは「思い出を殺すこと」だと感じるため、モノは堆積していきます。埃さえも「妖精の粉」のように捉えており、衛生観念は世間一般とは異なる独自基準。社会的なルールや効率性よりも、自分の内なる声や心地よさを優先して生きる自由人です。<br><br><h4>🏠 部屋の生態系と具体的特徴</h4><ul><li>部屋のあちこちに植物があり、半分は枯れているがそれも「味」としている。</li><li>布（ファブリック）が多く、部屋全体が柔らかい印象。</li><li>照明は薄暗く、キャンドルやランタンを好んで使う。</li><li>拾ってきた石や貝殻が大切に飾られている。</li></ul><br><h4>❤️ 対人関係の力学：魂の共鳴</h4>ロマンチストで、運命的な出会いを信じています。相手の条件やステータスではなく、「魂の波長」が合うか、「空気感」が心地よいかを重視します。傷つきやすく繊細なので、あなたの独特な世界観を否定せず、優しく守ってくれるナイトのようなパートナーを求めます。現実的な指摘をする相手とは、心が通じ合いません。<br><br><h4>💼 才能と職業的適性</h4>クリエイター、占い師、花屋、カウンセラー、絵本作家など、感性を活かして人を癒やしたり、物語を紡ぐ仕事に向いています。<br><br><h4>🌑 影の側面：ストレスと崩壊</h4>豊かな想像力を持ちますが、現実逃避しやすく、社会生活の厳しさや殺伐とした人間関係に疲れ果ててしまうことも。部屋はあなたを守るシェルターですが、引きこもりすぎると現実世界との接点を失い、ファンタジーの世界に永住してしまう危険性があります。セルフネグレクトへの警戒も必要です。<br><br><h4>💡 魂への処方箋</h4><b>「発信する」ことです。</b>あなたの内面世界は素晴らしい豊かさを持っていますが、部屋の中に閉じ込めておくだけではもったいない。絵を描く、文章を書く、あるいはその素敵な部屋の写真を撮る。あなたの魔法を外の世界に向けて表現してください。それは誰かの心を救う光になり、あなた自身を現実世界と繋ぎ止めるアンカーになります。""", 
        "color": "#4e342e"
    },
    "CWFP": {
        "title": "プロの厨房", 
        "copy": "道具への愛が、料理の味を変える", 
        "desc": """あなたの部屋の中心は、リビングでも寝室でもなく<b>「作業場（キッチンやアトリエ）」</b>です。壁にはスパイスの瓶や工具がズラリと並び、すべての道具が「使われる瞬間」を待ってスタンバイしています。単なる収集ではなく、あくまで「使うため」に集められた大量の道具たち。ここは生活の場である以上に、何かを生み出すためのスタジオであり、工房なのです。<br><br><h4>🧠 深層心理と認知プロセス</h4>「道具への愛」と「手順へのこだわり」が異常に強い職人気質。完璧なオムレツを作るためには、完璧なフライパンが必要だと信じて疑いません。効率的に作業するために整理整頓を徹底しており、道具の手入れを怠りません。人に何かを作ってあげたり、世話を焼くことに喜びを感じるギバー（与える人）でもありますが、その裏には「感謝されたい」という承認欲求も隠れています。<br><br><h4>🏠 部屋の生態系と具体的特徴</h4><ul><li>キッチンツールやDIY工具が壁掛け収納で見せる化されている。</li><li>冷蔵庫の中身はタッパーで分類され、賞味期限も管理されている。</li><li>友人やパートナーを招いてホームパーティーを開くのが好き。</li><li>一見散らかりそうだが、作業が終わると完璧に片付けられる。</li></ul><br><h4>❤️ 対人関係の力学：尽くし過ぎる愛</h4>パートナーの胃袋や生活を掴むのが得意です。世話好きで、相手のために何かをしてあげることに喜びを感じます。しかし、自分のこだわり（味付け、掃除の仕方、洗濯物の畳み方）が強すぎて、他人が手伝おうとすると「違う！そうじゃない」と手を出してしまう頑固さも。相手のためを思ってやっていることが、時に「押し付けがましい」と感じられることもあり、注意が必要です。<br><br><h4>💼 才能と職業的適性</h4>飲食関係、シェフ、パティシエ、美容師、あるいはチームを育成するマネージャー職など、技術と奉仕精神を活かせる仕事に向いています。<br><br><h4>🌑 影の側面：ストレスと崩壊</h4>高い実務能力と奉仕精神を持ちますが、完璧を求めるあまり、自分自身を酷使して燃え尽きてしまうことがあります。「こんなにしてあげたのに」という見返りを求める気持ちが芽生えたら危険信号。自分のケアをおろそかにし、自己犠牲の上に成り立つ奉仕は長続きしません。<br><br><h4>💡 魂への処方箋</h4><b>「手抜き」を覚えましょう。</b>弘法筆を選ばずと言いますが、最高の道具がなくても、そこそこのものは作れます。たまには冷凍食品を使ったり、コンビニ弁当で済ませる日を作ってください。あなたが眉間に皺を寄せて完璧な料理を作るよりも、力を抜いて笑っていることのほうが、周りの人にとっては「ご馳走」なのです。""", 
        "color": "#6d4c41"
    },
    "CWFL": {
        "title": "昭和レトロな下宿", 
        "copy": "コタツの上には常にミカン", 
        "desc": """コタツ、半纏、みかん、そして大量の「いつか使うかもしれないモノ」。あなたの部屋は、実家のような圧倒的な安心感と引力を持っています。色も柄もバラバラ、インテリアの統一感など皆無ですが、不思議と落ち着くのは、そこに<b>「人間の生活の匂い」</b>が充満しているからです。一度入ったら二度と出たくなくなる、底なし沼のような包容力を持った空間です。<br><br><h4>🧠 深層心理と認知プロセス</h4>「もったいない精神」の塊です。空き箱、包装紙、輪ゴムに至るまで、あらゆるモノに愛着と利用価値を見出します。変化を嫌い、現状維持を好む安定志向。片付けは苦手ですが、生活に必要なモノは手の届く範囲（コタツの周り）に全て集結しており、ある意味で究極のコックピットを形成しています。見栄を張ることの無意味さを悟っている達観した態度もあります。<br><br><h4>🏠 部屋の生態系と具体的特徴</h4><ul><li>テレビのリモコンにはラップが巻かれているかもしれない。</li><li>部屋の隅に新聞紙や雑誌が積み上がっている。</li><li>冬はコタツから出ずに全てを解決できる配置になっている。</li><li>最新のオシャレな家具よりも、座布団や座椅子を愛する。</li></ul><br><h4>❤️ 対人関係の力学：無償の受容</h4>駆け引きや刺激的な恋愛とは無縁です。一緒にテレビを見て笑い合えるような、家族的なパートナーシップを築きます。相手のダメなところも「しょうがないなぁ」と受け入れる深い度量がありますが、それが災いして、ヒモ男やダメンズ（ダメな人）を製造してしまうリスクも。あなたの前では誰もが武装解除し、ダメ人間になってしまうのです。<br><br><h4>💼 才能と職業的適性</h4>地方公務員、総務、介護職、農業、あるいはスナックのママ/マスターなど、地域や組織に根ざして、人々の生活を支える仕事が向いています。<br><br><h4>🌑 影の側面：ストレスと崩壊</h4>あなたがそこにいるだけで場が和む、天然の癒やしキャラです。しかし、モノへの執着は過去への執着でもあります。「捨てられない」ということは、新しい運気が入ってくるスペースがないということです。部屋が淀むと、思考もネガティブになり、過去の失敗をいつまでも反芻してしまう傾向があります。<br><br><h4>💡 魂への処方箋</h4><b>「賞味期限」を意識してください。</b>食べ物だけでなく、服や雑誌、そして人間関係にも賞味期限はあります。「いつか」は永遠に来ません。今日使わないものは、明日も使いません。感謝して手放すことで、あなたの人生の風通しは劇的に良くなり、新しい素敵な何かが舞い込んでくるでしょう。""", 
        "color": "#795548"
    },
}

# 全35問 (New Data)
QUESTIONS = [
    {"id": 1, "text": "「1つ買ったら1つ手放す」ルール、明日から実行できる？", "axis": "I", "options": {"A": "余裕。むしろ今すぐやりたい", "B": "無理。手放すのが惜しい"}},
    {"id": 2, "text": "旅先で「可愛い空き缶に入ったお菓子」を発見。どうする？", "axis": "I", "options": {"A": "缶がゴミになるので買わない", "B": "缶が欲しいから買う"}},
    {"id": 3, "text": "自宅の壁、何もない白いスペースを見てどう感じる？", "axis": "I", "options": {"A": "清々しい、そのままでいたい", "B": "なんだか寂しい、飾りたくなる"}},
    {"id": 4, "text": "推しのグッズや漫画、「全巻・全種類」揃ってないと嫌？", "axis": "I", "options": {"A": "興味ない / 1つだけでいい", "B": "揃ってないと気持ち悪い"}},
    {"id": 5, "text": "1年間一度も使わなかった「便利グッズ」の運命は？", "axis": "I", "options": {"A": "「役目は終わった」と即捨てる", "B": "「いつか使うかも」と取っておく"}},
    {"id": 6, "text": "トイレットペーパーや洗剤のストック、どうしてる？", "axis": "I", "options": {"A": "切れる直前に買う（場所優先）", "B": "安売りの日に買い込む（安心優先）"}},
    {"id": 7, "text": "あなたの部屋に「用途不明の謎のオブジェ」はある？", "axis": "I", "options": {"A": "ない（無駄なものは置かない）", "B": "ある（見て幸せなら必要）"}},
    {"id": 8, "text": "収納スペースが足りなくなったらどうする？", "axis": "I", "options": {"A": "物を減らして収める", "B": "収納家具を買い足す"}},
    {"id": 9, "text": "引っ越し前夜。荷造りをしていて思うことは？", "axis": "I", "options": {"A": "荷物少なっ！すぐ終わるわ", "B": "この山、どこから出てきた…？"}},
    {"id": 10, "text": "椅子を選ぶとき、最終的な決定打になるのは？", "axis": "II", "options": {"A": "座り心地・機能性", "B": "見た目のデザイン・ときめき"}},
    {"id": 11, "text": "夜、家でリラックスする時の「明かり」は？", "axis": "II", "options": {"A": "文字が読みやすい白い光", "B": "夕焼けのような薄暗いオレンジ光"}},
    {"id": 12, "text": "家電のデザイン、性能が全く同じならどっち？", "axis": "II", "options": {"A": "掃除しやすいフラットな形", "B": "愛着が湧くレトロな形"}},
    {"id": 13, "text": "10万円あげるから部屋に使ってと言われたら？", "axis": "II", "options": {"A": "最新の時短家電", "B": "ヴィンテージ家具や絵画"}},
    {"id": 14, "text": "生活感の象徴「ティッシュ箱」の扱いは？", "axis": "II", "options": {"A": "すぐ手が届く場所に置く", "B": "ケースに入れるか隠す"}},
    {"id": 15, "text": "家具の配置を決めるとき、最優先するのは？", "axis": "II", "options": {"A": "最短距離で動ける「効率」", "B": "部屋に入った瞬間の「見栄え」"}},
    {"id": 16, "text": "ゴミ箱を選ぶならどっち？", "axis": "II", "options": {"A": "ポイポイ捨てやすい口広タイプ", "B": "中身が見えない蓋付きタイプ"}},
    {"id": 17, "text": "部屋に置く時計は？", "axis": "II", "options": {"A": "正確なデジタル時計", "B": "雰囲気重視のアナログ時計"}},
    {"id": 18, "text": "「配線コード」へのスタンスは？", "axis": "II", "options": {"A": "使いやすいなら見えててOK", "B": "ノイズになるので隠したい"}},
    {"id": 19, "text": "無意識に触りたくなる素材はどっち？", "axis": "III", "options": {"A": "ツルッとしたガラス・金属", "B": "ざらっとした木・布"}},
    {"id": 20, "text": "集中したい時、行きたいカフェは？", "axis": "III", "options": {"A": "コンクリート打ちっ放しの店", "B": "木の温もりのある古民家風"}},
    {"id": 21, "text": "部屋のベースカラーにするなら？", "axis": "III", "options": {"A": "モノトーン（白・黒・グレー）", "B": "アースカラー（ベージュ・茶・緑）"}},
    {"id": 22, "text": "観葉植物（グリーン）に対する本音は？", "axis": "III", "options": {"A": "虫が嫌。置くならフェイク", "B": "成長が好き。ジャングルにしたい"}},
    {"id": 23, "text": "窓周り（カーテン）の理想は？", "axis": "III", "options": {"A": "ブラインドで直線を強調", "B": "カーテンで光を柔らかく拡散"}},
    {"id": 24, "text": "革製品やデニムの「色落ち」は？", "axis": "III", "options": {"A": "汚らしく見える。新品がいい", "B": "愛おしい。「味」こそ正義"}},
    {"id": 25, "text": "PCやガジェットのデザインは？", "axis": "III", "options": {"A": "メカメカしいのが好き", "B": "木目調などで機械っぽさを消したい"}},
    {"id": 26, "text": "家でのリラックススタイルは？", "axis": "III", "options": {"A": "ソファや椅子に座る", "B": "ラグや畳の上でゴロゴロ"}},
    {"id": 27, "text": "理想の「静寂」のイメージは？", "axis": "III", "options": {"A": "都会の高級ホテルの静けさ", "B": "森の中のコテージの静けさ"}},
    {"id": 28, "text": "残業でクタクタ。帰宅後の上着とカバンは？", "axis": "IV", "options": {"A": "どんなに疲れていても定位置へ", "B": "とりあえずソファや床にドサッ"}},
    {"id": 29, "text": "リモコンの並び順や向きがズレていたら？", "axis": "IV", "options": {"A": "無意識に直してしまう", "B": "全く気にならない"}},
    {"id": 30, "text": "「あとで片付ける」と言った自分を信じられる？", "axis": "IV", "options": {"A": "信じられる（当日中にやる）", "B": "信じられない（数日放置）"}},
    {"id": 31, "text": "本棚の「本の高さ」がバラバラだと？", "axis": "IV", "options": {"A": "気持ち悪いので揃えたい", "B": "読めればどうでもいい"}},
    {"id": 32, "text": "引き出しの中身、いきなり他人に見せられる？", "axis": "IV", "options": {"A": "いつでも見せられる", "B": "開ける前に3分待ってほしい"}},
    {"id": 33, "text": "床に髪の毛が一本落ちているのを見つけたら？", "axis": "IV", "options": {"A": "見つけ次第すぐ取る", "B": "ある程度溜まってから掃除"}},
    {"id": 34, "text": "突然「今から家行っていい？」と連絡が！反応は？", "axis": "IV", "options": {"A": "「どうぞ」と即座に通せる", "B": "「待って！」と慌てて物を隠す"}},
    {"id": 35, "text": "ベッドメイキング（布団を整えること）は？", "axis": "IV", "options": {"A": "毎朝のルーティン", "B": "夜どうせ寝るからそのままでいい"}},
]

# ==========================================
# 3. ロジック関数
# ==========================================

def calculate_result(answers):
    scores = {"I": 0, "II": 0, "III": 0, "IV": 0}
    for q_id, choice in answers.items():
        question = next((q for q in QUESTIONS if q["id"] == q_id), None)
        if question:
            if choice == "A": scores[question["axis"]] += 1
            else: scores[question["axis"]] -= 1
    
    c1 = "M" if scores["I"] >= 0 else "C"
    c2 = "S" if scores["III"] >= 0 else "W"
    c3 = "F" if scores["II"] >= 0 else "E"
    c4 = "P" if scores["IV"] >= 0 else "L"
    
    final_key = c1 + c3 + c2 + c4
    if final_key not in TYPES:
        alt_key = c1 + c2 + c3 + c4 
        final_key = alt_key if alt_key in TYPES else "MFSP"
            
    return final_key, scores

def create_radar_chart(scores, color_hex):
    val_i = 5 + (scores["I"] * 0.5)
    val_ii = 5 + (scores["II"] * 0.5)
    val_iii = 5 + (scores["III"] * 0.5)
    val_iv = 5 + (scores["IV"] * 0.5)
    
    categories = ['物量(Mini)', '機能(Func)', 'モダン(Sharp)', '幾帳面(Perf)']
    values = [val_i, val_ii, val_iii, val_iv]
    categories.append(categories[0])
    values.append(values[0])

    fig = go.Figure(data=go.Scatterpolar(
        r=values,
        theta=categories,
        fill='toself',
        fillcolor=f'rgba{tuple(int(color_hex.lstrip("#")[i:i+2], 16) for i in (0, 2, 4)) + (0.2,)}',
        line_color=color_hex,
        marker=dict(size=6)
    ))

    fig.update_layout(
        font=dict(family="Zen Maru Gothic", size=14, color="#333333"),
        polar=dict(
            bgcolor='white',
            radialaxis=dict(
                visible=True, range=[0, 10], 
                linecolor='#999', gridcolor='#eee', 
                showticklabels=False
            ),
            angularaxis=dict(
                linecolor='#999', gridcolor='#eee',
                tickfont=dict(size=14, color='#333333', weight='bold') # 軸文字を濃く・大きく
            )
        ),
        showlegend=False,
        margin=dict(t=40, b=40, l=40, r=40),
        height=300,
        paper_bgcolor='rgba(0,0,0,0)',
    )
    return fig

# ==========================================
# 4. アプリケーション本体 (ディープリンク対応版)
# ==========================================

# テキストクリーニング関数
def clean_text_for_markdown(text):
    """
    Pythonコード上の改行やインデントを全て除去し、
    完全にフラットな1行の文字列にする。
    これによりMarkdownのコードブロック誤認識を100%防ぐ。
    """
    # 改行を削除
    text = text.replace('\n', ' ')
    # 連続する空白を1つにまとめる
    text = re.sub(r'\s+', ' ', text)
    return text.strip()

def get_phase_info(q_index):
    """現在の質問番号(0始まり)から、フェーズ情報とカラーを取得する"""
    if q_index < 9:
        return {
            "name": "PHASE 1", 
            "color_start": "#4facfe", # 水色
            "color_end": "#00f2fe",
            "theme": "cyan"
        }
    elif q_index < 18:
        return {
            "name": "PHASE 2", 
            "color_start": "#43e97b", # 緑
            "color_end": "#38f9d7",
            "theme": "green"
        }
    elif q_index < 27:
        return {
            "name": "PHASE 3", 
            "color_start": "#fa709a", # オレンジ〜ピンク
            "color_end": "#fee140",
            "theme": "orange"
        }
    else:
        return {
            "name": "PHASE 4", 
            "color_start": "#667eea", # 紫
            "color_end": "#764ba2",
            "theme": "purple"
        }

# ★移動：定義をmainの前に持ってくる
def show_result_content(type_key, result_data, scores=None, is_shared_view=False):
    """結果画面の中身を表示する共通関数"""
    
    st.markdown(f"""
    <div class='result-container'>
        <p style='color: #888; font-size: 12px; margin-bottom: 5px; text-transform: uppercase;'>Diagnosis Result</p>
        <h2 class='result-title' style='color: {result_data['color']};'>{type_key}：{result_data['title']}</h2>
    </div>
    """, unsafe_allow_html=True)
    
    st.markdown("<div style='height: 20px;'></div>", unsafe_allow_html=True)

    image_path = f"assets/{type_key}.png"
    if os.path.exists(image_path):
        st.image(image_path, use_container_width=True)
    else:
        st.warning(f"画像が見つかりません: {image_path}")
        st.image(f"https://placehold.co/800x500/{result_data['color'].replace('#','')}/FFFFFF?text={result_data['title']}", use_container_width=True)
    
    # --- 説明文の分割表示ロジック ---
    full_text_cleaned = clean_text_for_markdown(result_data['desc'])
    
    split_marker = "<h4>"
    split_index = full_text_cleaned.find(split_marker)
    
    if split_index != -1:
        intro_text = full_text_cleaned[:split_index]
        detail_text = full_text_cleaned[split_index:]
    else:
        intro_text = full_text_cleaned
        detail_text = ""

    # 1. 導入文
    intro_html = f"<div class='result-copy'>{clean_text_for_markdown(result_data['copy'])}</div><div class='result-desc-box'><div class='result-desc'>{intro_text}</div></div>"
    st.markdown(intro_html, unsafe_allow_html=True)

    # 2. 詳細分析（もっと見る）
    if detail_text:
        with st.expander("📖 もっと見る"):
            detail_html = f"<div class='result-desc-box'><div class='result-desc'>{detail_text}</div></div>"
            st.markdown(detail_html, unsafe_allow_html=True)
    
    if scores:
        st.markdown('### <span class="gradient-text-cool">📊 部屋の成分表</span>', unsafe_allow_html=True)
        chart = create_radar_chart(scores, result_data['color'])
        st.plotly_chart(chart, use_container_width=True)
    
    # SNSシェアセクション
    base_url = "https://room-diagnosis.streamlit.app"
    share_url = f"{base_url}?id={type_key}"
    share_text = f"私の部屋タイプは【{result_data['title']}】でした！\n部屋の正体を暴く診断アプリ #部屋タイプ診断"
    
    encoded_text = urllib.parse.quote(share_text)
    encoded_url = urllib.parse.quote(share_url)
    
    twitter_url = f"https://twitter.com/intent/tweet?text={encoded_text}&url={encoded_url}"
    line_url = f"https://line.me/R/msg/text/?{encoded_text}%20{encoded_url}"
    facebook_url = f"https://www.facebook.com/sharer/sharer.php?u={encoded_url}"
    
    st.markdown('### <span class="gradient-text-warm">🤝 診断結果をシェア</span>', unsafe_allow_html=True)
    s1, s2, s3 = st.columns(3)
    with s1:
        st.link_button("X (Twitter)", twitter_url, use_container_width=True, type="secondary")
    with s2:
        st.link_button("LINE", line_url, use_container_width=True, type="secondary")
    with s3:
        st.link_button("Facebook", facebook_url, use_container_width=True, type="secondary")
        
    st.caption("▼ リンクをコピーしてシェア")
    st.code(share_url, language="text") 
    
    st.markdown("<div style='height: 30px;'></div>", unsafe_allow_html=True)
    
    col1, col2 = st.columns(2)
    with col1:
        if is_shared_view:
             if st.button("✨ 私も診断してみる", type="primary", use_container_width=True):
                st.session_state.page = 'home'
                st.query_params.clear()
                st.rerun()
        else:
            pass 

    with col2:
        if not is_shared_view:
            if st.button("🏠 トップへ戻る", type="secondary", use_container_width=True):
                st.session_state.page = 'home'
                st.rerun()

def main():
    st.set_page_config(page_title="Room Type Diagnosis", page_icon="🏠", layout="centered")
    
    # セッションの初期化
    if 'page' not in st.session_state: 
        # Deep Linking check
        query_params = st.query_params
        shared_id = query_params.get("id", None)
        if shared_id and shared_id in TYPES:
            st.session_state.page = 'shared_result'
            st.session_state.shared_id = shared_id
        else:
            st.session_state.page = 'home'
            
    if 'answers' not in st.session_state: st.session_state.answers = {}
    if 'current_q_index' not in st.session_state: st.session_state.current_q_index = 0
    if 'history' not in st.session_state: st.session_state.history = []

    # フェーズ情報の取得とCSS適用
    current_phase = get_phase_info(st.session_state.current_q_index)
    apply_custom_style(current_phase if st.session_state.page == 'quiz' else None)

    # --- 画面遷移 ---

    # A. ホーム画面
    if st.session_state.page == 'home':
        # ★修正：トップ画面のHTMLも1行にして黒いボックスを確実に回避★
        hero_html = """
        <div class='hero-container'>
            <div class='hero-title'>
                あなたの「居場所」の正体、暴きます。
            </div>
            <div class='hero-subtitle'>
                部屋は心を映す鏡です。<br>
                たった3分の質問に答えるだけで、<br>
                あなたの隠された<b>「部屋の種族」</b>を判定します。
            </div>
        </div>
        """
        st.markdown(clean_text_for_markdown(hero_html), unsafe_allow_html=True)
        
        if st.button("📜 過去の履歴を見る", type="secondary", use_container_width=True):
            st.session_state.page = 'history'
            st.rerun()

        st.markdown("<div style='height: 15px;'></div>", unsafe_allow_html=True)

        if st.button("診断をスタートする →", type="primary", use_container_width=True):
            st.session_state.page = 'quiz'
            st.session_state.current_q_index = 0
            st.session_state.answers = {}
            st.rerun()

        st.markdown("""
        <div style='margin-top: 15px; text-align: center; color: #888; font-size: 12px; margin-bottom: 40px;'>
            ✨ 登録不要 / 無料で診断できます
        </div>
        """, unsafe_allow_html=True)

        f1, f2, f3 = st.columns(3)
        with f1:
            st.markdown("""<div class='feature-box'><span class='feature-icon'>⏱</span><span class='feature-title'>所要時間は3分</span><span class='feature-desc'>直感的に答えるだけ。<br>サクサク進みます。</span></div>""", unsafe_allow_html=True)
        with f2:
            st.markdown("""<div class='feature-box'><span class='feature-icon'>🧠</span><span class='feature-title'>独自の分析ロジック</span><span class='feature-desc'>4つの軸から、あなたの<br>生活スタイルを解析。</span></div>""", unsafe_allow_html=True)
        with f3:
            st.markdown("""<div class='feature-box'><span class='feature-icon'>🏠</span><span class='feature-title'>全16タイプ</span><span class='feature-desc'>ミニマリストから<br>コレクターまで網羅。</span></div>""", unsafe_allow_html=True)

    # B. 診断画面
    elif st.session_state.page == 'quiz':
        progress = (st.session_state.current_q_index + 1) / len(QUESTIONS)
        st.progress(progress)
        
        q_data = QUESTIONS[st.session_state.current_q_index]
        phase = get_phase_info(st.session_state.current_q_index)
        
        # フェーズバッジの表示
        st.markdown(f"<div style='text-align:center;'><span class='phase-badge'>{phase['name']}</span></div>", unsafe_allow_html=True)
        
        st.markdown(f"""
        <div class='question-card'>
            <div class='question-number'>QUESTION {st.session_state.current_q_index + 1} / {len(QUESTIONS)}</div>
            <div class='question-text'>{q_data['text']}</div>
        </div>
        """, unsafe_allow_html=True)
        
        col1, col2 = st.columns(2)
        with col1:
            if st.button(f"🅰️ {q_data['options']['A']}", type="secondary", use_container_width=True, key=f"q{q_data['id']}_a"):
                st.session_state.answers[q_data['id']] = "A"
                next_question()
        with col2:
            if st.button(f"🅱️ {q_data['options']['B']}", type="secondary", use_container_width=True, key=f"q{q_data['id']}_b"):
                st.session_state.answers[q_data['id']] = "B"
                next_question()
        
        st.markdown("<div style='margin-top: 30px; text-align: center;'>", unsafe_allow_html=True)
        if st.session_state.current_q_index > 0:
            if st.button("戻る", use_container_width=False):
                st.session_state.current_q_index -= 1
                st.rerun()

    # C. 結果画面 (診断直後)
    elif st.session_state.page == 'result':
        type_key, scores = calculate_result(st.session_state.answers)
        result_data = TYPES[type_key]
        
        # 履歴保存
        if not any(d['date'] == st.session_state.get('last_run') for d in st.session_state.history):
             run_time = datetime.now().strftime("%Y/%m/%d %H:%M")
             st.session_state.history.insert(0, {"date": run_time, "type": type_key, "title": result_data['title']})
             st.session_state.last_run = run_time

        show_result_content(type_key, result_data, scores) # 結果表示の共通関数を呼び出し

    # D. 共有された結果画面 (クイズせずに見る画面)
    elif st.session_state.page == 'shared_result':
        type_key = st.session_state.shared_id
        result_data = TYPES[type_key]
        
        st.info("💡 シェアされた診断結果を表示しています")
        show_result_content(type_key, result_data, None, is_shared_view=True)


    # E. 履歴画面
    elif st.session_state.page == 'history':
        st.markdown("<h2 style='text-align: center; color: #333;'>HISTORY</h2>", unsafe_allow_html=True)
        if not st.session_state.history:
            st.info("まだ履歴がありません")
        else:
            for item in st.session_state.history:
                st.markdown(f"""
                <div style='background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05);'>
                    <small style='color: #999'>{item['date']}</small><br>
                    <b style='font-size: 18px; color: #333'>{item['title']}</b>
                    <span style='float: right; color: #aaa'>#{item['type']}</span>
                </div>
                """, unsafe_allow_html=True)
        
        if st.button("戻る", type="secondary", use_container_width=True):
            st.session_state.page = 'home'
            st.rerun()

def next_question():
    if st.session_state.current_q_index < len(QUESTIONS) - 1:
        st.session_state.current_q_index += 1
        st.rerun()
    else:
        with st.spinner('Analying...'):
            time.sleep(1.0) 
        st.session_state.page = 'result'
        st.rerun()

if __name__ == "__main__":
    main()